---
title: "Sleep Summary Stats Comparison"
author: "Megan McMahon"
date: "3/12/2021"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(readr)
library(tidyverse)
library(reshape2)

```

```{r}
data_dir <- '~/Box/CogNeuroLab/Wearables/data/'
fit <- read_csv(paste0(data_dir, 'fitbit/fitbitSleepStatsGroup.csv'))
act <- read_csv(paste0(data_dir, 'actiwatch/wa_act_combined.csv'))
act_cl <- read_csv(paste0(data_dir, 'actiwatch/actiware_manual_clean/wa_act_combined.csv'))

df_cx <- readr::read_csv(paste0(data_dir, 'df_main.csv'))

head(act)
```

```{r read}

#clean actiware datasets

clean_actiware_combined_df <- function(df) {
  TimeInBed <- df %>%
  filter(interval_type == 'REST') %>%
  select(subject_id, start_date, duration)

dfnew <- df %>%
  filter(interval_type == 'SLEEP') %>%
  merge(TimeInBed, by = c('subject_id', 'start_date')) %>%
  rename(time_in_bed = duration.y, time_asleep = duration.x) %>%
  select(-X31, -(number_of_scores:avg_scheduled), -interval_type, -interval_number) %>%
  mutate(date = format(lubridate::round_date(lubridate::parse_date_time(paste0(start_date, ' ', start_time), '%m/%d/%Y %I:%M:%S %p'), unit = 'd'), '%Y-%m-%d'),
         joinid = paste0(subject_id, '_', date))
 
return(dfnew) 
}

act <- clean_actiware_combined_df(act)
act_cl <- clean_actiware_combined_df(act_cl)
head(act)
```


```{r}
#fitbit subject numbers are different for subjects who used Beiwe, so need to match them with their full subject number from Actiware
match_subject_number <- function(data, pad_digits, match_to){
    for (i in unique(data$subject[data$subject < 10000])){
    subno <- data$subject[grep(paste0('[1-2]', stringr::str_pad(i, pad_digits, side = 'left', pad = '0')), match_to)][1]
    if (! is.na(subno)){
      data$subject[data$subject == i] <- subno
    }
    }
  return(data)
}
fit <- match_subject_number(fit, 4, act$subject_id)
head(fit)
```

```{r}
# match date formats between fitbit and actiwatch datasets
act_cl <- act_cl %>%
  mutate(cleaned = ifelse(analysis_name == "Manual", 1, 0))

actall <- act %>%
  merge(act_cl, by = c('joinid', 'subject_id', 'date'), suffixes = c('_act', '_cl'))

head(actall)
```

```{r}
fitnew <- fit %>% 
  mutate(date = format(lubridate::parse_date_time(StartTime, '%m/%d/%Y %I:%M:%S %p'), format = '%Y-%m-%d'), 
         joinid = paste0(subject, '_', format(date, format = '%Y-%m-%d'))) %>%
  rename(time_asleep = TotalMinutesAsleep, time_in_bed = TotalTimeInBed, start_time = StartTime, efficiency = Efficiency, min_after_wake = MinutesAfterWakeup, onset_latency = MinutesToFallAsleep, awake_count = AwakeCount, awake_duration = AwakeDuration, restless_count = RestlessCount, restless_duration = RestlessDuration) %>%
  select(-X1, -Duration, -MinutesAsleep, -TimeInBed) %>%
  rename_at(vars(-subject, -date, -joinid), ~ paste0(., '_fit'))

head(fitnew)
```


```{r}
df <- merge(actall, fitnew, by = 'joinid')

write_csv(df, paste0(data_dir, 'sleep-summary_act-auto_act-cl_fitbit.csv'))

df %>%
  select(subject, matches('time_asleep')) %>%
  head()

```

```{r}
df <- merge(df, df_cx, by = 'subject')
```

```{r}
df_cx %>%
  mutate(age_group = recode(age_group, "Young Adults", "Older Adults")) %>%
  mutate(handedness = recode(handedness, "Left", "Right", "Both")) %>%
  mutate(actiwatch_arm = recode(actiwatch_arm, "Left", "Right")) %>%
  mutate(dominant = ifelse(handedness == actiwatch_arm, 1, 0)) %>%
  group_by(age_group, dominant) %>%
  summarise(n = n())

df_cx %>%
  mutate(age_group = recode(age_group, "Young Adults", "Older Adults")) %>%
  mutate(handedness = recode(handedness, "Left", "Right", "Both")) %>%
  mutate(actiwatch_arm = recode(actiwatch_arm, "Left", "Right")) %>%
  filter(handedness == "Right") %>%
  mutate(dominant = ifelse(handedness == actiwatch_arm, 1, 0)) %>%
  group_by(age_group, dominant) %>%
  summarise(n = n())

df_cx %>%
  mutate(age_group = recode(age_group, "Young Adults", "Older Adults")) %>%
  mutate(handedness = recode(handedness, "Left", "Right", "Both")) %>%
  mutate(actiwatch_arm = recode(actiwatch_arm, "Left", "Right")) %>%
  filter(handedness == "Left") %>%
  mutate(dominant = ifelse(handedness == actiwatch_arm, 1, 0)) %>%
  group_by(age_group, dominant) %>%
  summarise(n = n())
```


```{r}
exclude = c('10023', '10076', '20182', '20184', '20176', '10151', '10139')
df <- df[!df$subject %in% exclude, ]

df_means <- df %>%
  select(subject_id, analysis_name_cl, where(is.numeric)) %>%
  group_by(subject, analysis_name_cl) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

head(df_means)

```

## Correlations

```{r}
library(corrr)
library(purrr)
library(dplyr)

df %>%
  group_by(subject) %>%
  select(where(is.numeric)) %>%
  group_by(subject) %>%
  summarise_at(vars(-subject_id), funs(mean(., na.rm=TRUE))) %>%
  corrr::correlate(method = 'spearman') %>%
  corrr::focus(matches('time_asleep'), mirror = TRUE) 

```

```{r}
df %>%
  group_by(subject) %>%
  filter(handedness == 2) %>%
  select(where(is.numeric)) %>%
  group_by(subject) %>%
  summarise_at(vars(-subject_id), funs(mean(., na.rm=TRUE))) %>%
  corrr::correlate(method = 'spearman') %>%
  corrr::focus(matches('time_asleep'), mirror = TRUE) 
```

```{r}
df %>% #all
  group_by(subject) %>%
  select(where(is.numeric)) %>%
  group_by(subject) %>%
  summarise_at(vars(-subject_id), funs(mean(., na.rm=TRUE))) %>%
  corrr::correlate(method = 'spearman') %>%
  corrr::focus(matches('bed'), mirror = TRUE) 
```

```{r}
df %>% #right handed only
  group_by(subject) %>%
  filter(handedness == 2) %>%
  select(where(is.numeric)) %>%
  group_by(subject) %>%
  summarise_at(vars(-subject_id), funs(mean(., na.rm=TRUE))) %>%
  corrr::correlate(method = 'spearman') %>%
  corrr::focus(matches('bed'), mirror = TRUE) 

```


```{r}
library(RColorBrewer)

df_means %>%
  ggplot(aes(x = time_asleep_cl, y = time_asleep_fit, color = analysis_name_cl)) +
  geom_point() +
  stat_smooth(method = 'lm') +
  scale_color_brewer(palette = 'Set1')


```

```{r}
df_means %>%
  ggplot(aes(x = time_in_bed_cl, y = time_in_bed_fit, color = analysis_name_cl)) +
  geom_point() +
  stat_smooth(method = 'lm') +
  scale_color_brewer(palette = 'Set1')

```

```{r}
# excluded subject 10139
df_means %>%
  ggplot(aes(x = time_in_bed_cl)) +
  geom_boxplot() 

df_means$subject[df_means$time_in_bed_cl > 700]
```

### Repeated measures correlations

[Documentation](https://cran.r-project.org/web/packages/rmcorr/rmcorr.pdf)

[Repeated Measures Correlation, Bakdash1 and Marusich, 2017](https://www.frontiersin.org/articles/10.3389/fpsyg.2017.00456/full)

#### Time in Bed
```{r}
library(rmcorr)

colourCount = length(unique(df$subject))
getPalette = colorRampPalette(brewer.pal(9, "Spectral"))

my.rmc <- rmcorr(participant = subject, measure1 = time_in_bed_act, measure2 = time_in_bed_fit, dataset = df)
plot(my.rmc, overall = TRUE)

```

```{r}
ggplot2::ggplot(df, ggplot2::aes(x = time_in_bed_act, y = time_in_bed_fit, group = factor(subject),
      color = factor(subject))) +
      ggplot2::geom_point(ggplot2::aes(colour = factor(subject))) +
      ggplot2::geom_line(ggplot2::aes(y = my.rmc$model$fitted.values), linetype = 1) + xlab('Actiwatch 2.0') + ylab('Fitbit') + ggtitle('Time In Bed') + scale_color_manual(values = getPalette(colourCount)) + labs(color = 'Subject') + ggsave(paste0(data_dir, 'CARE2021/figures/timeinbedrmcorr.png'), height = 5, width = 8, dpi = 300)

```

#### Time in Bed: Cleaned Actiwatch data
```{r}
my.rmc <- rmcorr(participant = subject, measure1 = time_in_bed_cl, measure2 = time_in_bed_fit, dataset = df[df$age_group == 1,])

ggplot2::ggplot(df[df$age_group == 1,], ggplot2::aes(x = time_in_bed_cl, y = time_in_bed_fit, group = factor(subject),
      color = factor(subject))) +
      ggplot2::geom_point(ggplot2::aes(colour = factor(subject))) +
      ggplot2::geom_line(ggplot2::aes(y = my.rmc$model$fitted.values), linetype = 1) + xlab('Actiwatch 2.0') + ylab('Fitbit') + ggtitle('Time In Bed') + scale_color_manual(values = getPalette(colourCount)) + labs(color = 'Subject')

```
#### Time in bed: correlations
```{r}
#raw
rmcorr(subject, time_in_bed_act, time_in_bed_fit, df)
rmcorr(subject, time_in_bed_act, time_in_bed_fit, filter(df, handedness == 2))
rmcorr(subject, time_in_bed_act, time_in_bed_fit, filter(df, (actiwatch_arm == 1) & (handedness == 2)))
rmcorr(subject, time_in_bed_act, time_in_bed_fit, filter(df, (actiwatch_arm == 2) & (handedness == 2)))

# manually cleaned
rmcorr(subject, time_in_bed_cl, time_in_bed_fit, df)
rmcorr(subject, time_in_bed_cl, time_in_bed_fit, filter(df, handedness == 2))
rmcorr(subject, time_in_bed_cl, time_in_bed_fit, filter(df, (actiwatch_arm == 1) & (handedness == 2)))
rmcorr(subject, time_in_bed_cl, time_in_bed_fit, filter(df, (actiwatch_arm == 2) & (handedness == 2)))

```

#### Sleep time

```{r}
my.rmc <- rmcorr(participant = subject, measure1 = time_asleep_act, measure2 = time_asleep_fit, dataset = df)

ggplot2::ggplot(df, ggplot2::aes(x = time_asleep_act, y = time_asleep_fit, group = factor(subject),
      color = factor(subject))) +
      ggplot2::geom_point(ggplot2::aes(colour = factor(subject))) +
      ggplot2::geom_line(ggplot2::aes(y = my.rmc$model$fitted.values), linetype = 1) + xlab('Actiwatch 2.0') + ylab('Fitbit') + ggtitle('Time Asleep') + scale_color_manual(values = getPalette(colourCount)) + labs(color = 'Subject') + ggsave(paste0(data_dir, 'CARE2021/figures/sleeptimermcorr.png'), height = 5, width = 8, dpi = 300)

```

#### Sleep Time: Cleaned Actiwatch data

```{r}
my.rmc <- rmcorr(participant = subject, measure1 = time_asleep_cl, measure2 = time_asleep_fit, dataset = df[df$age_group == 1,], nreps=500)

ggplot2::ggplot(df[df$age_group == 1,], ggplot2::aes(x = time_asleep_cl, y = time_asleep_fit, group = factor(subject),
      color = factor(subject))) +
      ggplot2::geom_point(ggplot2::aes(colour = factor(subject))) +
      ggplot2::geom_line(ggplot2::aes(y = my.rmc$model$fitted.values), linetype = 1) + xlab('Actiwatch 2.0') + ylab('Fitbit') + ggtitle('Time Asleep') + scale_color_manual(values = getPalette(colourCount)) + labs(color = 'Subject')

```

```{r}
#raw
rmcorr(subject, time_asleep_act, time_asleep_fit, df)
rmcorr(subject, time_asleep_act, time_asleep_fit, filter(df, handedness == 2))
rmcorr(subject, time_asleep_act, time_asleep_fit, filter(df, (actiwatch_arm == 1) & (handedness == 2)))
rmcorr(subject, time_asleep_act, time_asleep_fit, filter(df, (actiwatch_arm == 2) & (handedness == 2)))

# manually cleaned
rmcorr(subject, time_asleep_cl, time_asleep_fit, df)
rmcorr(subject, time_asleep_cl, time_in_bed_fit, filter(df, handedness == 2))
rmcorr(subject, time_asleep_cl, time_in_bed_fit, filter(df, (actiwatch_arm == 1) & (handedness == 2)))
rmcorr(subject, time_asleep_cl, time_in_bed_fit, filter(df, (actiwatch_arm == 2) & (handedness == 2)))

```

```{r}
rmcorr(subject, time_asleep_act, time_in_bed_fit, df)

```

### Efficiency

```{r}
my.rmc <- rmcorr(participant = subject, measure1 = efficiency_act, measure2 = efficiency_fit, dataset = df[df$age_group == 1,], nreps=500)

ggplot2::ggplot(df[df$age_group == 1,], ggplot2::aes(x = efficiency_act, y = efficiency_fit, group = factor(subject),
      color = factor(subject))) +
      ggplot2::geom_point(ggplot2::aes(colour = factor(subject))) +
      ggplot2::geom_line(ggplot2::aes(y = my.rmc$model$fitted.values), linetype = 1) + xlab('Actiwatch 2.0') + ylab('Fitbit') + ggtitle('Sleep Efficiency') + scale_color_manual(values = getPalette(colourCount)) + labs(color = 'Subject')

```

```{r}
rmcorr(subject, efficiency_act, efficiency_fit, df)

```

### Next steps: 
Need correlation value for each subject, then see how that's related to measures of subjective sleep quality, handedness, arm assignment, percent watch off, beiwe, fitbit device

```{r}
corrdf <- df %>%
  group_by(subject) %>%
  summarize(sleep_time = cor(time_asleep_act, time_asleep_fit, method = 'spearman'), time_in_bed = cor(time_in_bed_act, time_in_bed_fit, method = 'spearman'))

head(corrdf)

```
```{r}
dfcor <- merge(df, corrdf, by = 'subject')

head(dfcor)

```

```{r}
unique(dfcor$subject[dfcor$time_in_bed < 0.5])
length(unique(dfcor$subject[dfcor$time_in_bed < 0.5]))

unique(dfcor$subject[dfcor$sleep_time < 0.5])
length(unique(dfcor$subject[dfcor$sleep_time < 0.5]))

```


```{r}

require(gridExtra)

plot1 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = fitbit_device, y = sleep_time, fill = fitbit_device, group = fitbit_device)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1')

plot2 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = fitbit_device, y = time_in_bed, fill = fitbit_device, group = fitbit_device)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + theme(axis.text.x = element_text(angle = 90))

grid.arrange(plot1, plot2, ncol=2)

```

```{r}
dfcor$handedness <- factor(dfcor$handedness, labels = c("Right", "Left", "Both"))

plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = handedness, y = sleep_time, fill = handedness, group = handedness)) +
  ylab('Sleep Time Correlation (r)') + xlab('Handedness') +
  scale_fill_brewer(palette = 'Set1') 

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = handedness, y = time_in_bed, fill = handedness, group = handedness)) +
  ylab('Time In Bed Correlation (r)') + xlab('Handedness') +
  scale_fill_brewer(palette = 'Set1')

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/handedness.png", pnew, height = 5, width = 10, units = "in")

plot(pnew)
```

```{r}
dfcor$actiwatch_arm <- factor(dfcor$actiwatch_arm, labels = c("Right", "Left"))

plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = actiwatch_arm, y = sleep_time, fill = handedness, group = handedness)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = actiwatch_arm, y = time_in_bed, fill = handedness, group = handedness)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/actiwatchassignment.png", pnew, height = 5, width = 10, units = "in")

plot(pnew)
```

```{r}
dfcor$dominant_assignment <- factor(ifelse(as.character(dfcor$actiwatch_arm) == as.character(dfcor$handedness), 1, 0), labels = c("Dominant", "Non-Dominant"))

df_means$dominant_assignment <- factor(ifelse(as.character(df_means$actiwatch_arm) == as.character(df_means$handedness), 1, 0), labels = c("Dominant", "Non-Dominant"))

plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = dominant_assignment, y = sleep_time, fill = dominant_assignment, group = dominant_assignment)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = dominant_assignment, y = time_in_bed, fill = dominant_assignment, group = dominant_assignment)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/actiwatchassignment_dominant.png", pnew, height = 5, width = 10, units = "in")

summary(lm(time_asleep_act ~ time_asleep_fit + dominant_assignment, data = df_means))
summary(lm(time_in_bed_act ~ time_in_bed_fit + dominant_assignment, data = df_means))

plot(pnew)
```

```{r}
dfcor$age_group <- factor(dfcor$age_group, labels = c("Young Adults", "Older Adults"))

plot1 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = sleep_time, fill = age_group, group = age_group)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

plot2 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = time_in_bed, fill = age_group, group = age_group)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/agegroup.png", pnew, height = 5, width = 10, units = "in")

```


```{r}
write.csv(dfcor, paste0(data_dir, 'sleep_summary_condition_correlation.csv'))

```

## Bland Altman plots

About the package: [blandr](https://cran.r-project.org/web/packages/blandr/vignettes/introduction.html)
Interpretation: [Statology](https://www.statology.org/bland-altman-plot/)

e.g.

The average of the values in the Difference column turns out to be 0.5. (middle line)
The standard deviation of values in the Difference column turns out to be 1.235.
The upper and lower limits of the confidence interval for the average difference can be calculated as:

Upper Limit: x + 1.96*s = 0.5 + 1.96*1.235 = 2.92
Lower Limit: x – 1.96*s = 0.5 – 1.96*1.235 = -1.92

On average, instrument A weighs frogs to be 0.5 grams heavier than instrument B.
95% of the differences in weight between the two instruments are expected to fall in the range of -1.92 grams and 2.92 grams.

First look at which device may be under or over estimating
- Fitbit underestimating sleep time and time in bed

```{r}

# fitbit underestimating sleep time
df %>%
  ggplot(aes(x = time_asleep_act, y = time_asleep_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

df %>%
  ggplot(aes(x = time_asleep_cl, y = time_asleep_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

#fitbit underestimating time in bed
df %>%
  ggplot(aes(x = time_in_bed_act, y = time_in_bed_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

df %>%
  ggplot(aes(x = time_in_bed_cl, y = time_in_bed_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

```

```{r}
library(blandr)

df.stats <- blandr.statistics(df$time_asleep_act , df$time_asleep_fit)
p1 <- blandr.draw(df$time_asleep_act , df$time_asleep_fit ) + ggtitle(paste("Raw Actiwatch, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_asleep_cl , df$time_asleep_fit)
p2 <- blandr.draw(df$time_asleep_cl , df$time_asleep_fit) + ggtitle(paste("Cleaned Actiwatch, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_asleep_act[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)])
p3 <- blandr.draw(df$time_asleep_act[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)]) + ggtitle(paste("Raw, RH, Non-Dominant, \n \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_asleep_act[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)])
p4 <- blandr.draw(df$time_asleep_act[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)]) + ggtitle(paste("Raw, RH, Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_asleep_cl[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)])
p5 <- blandr.draw(df$time_asleep_cl[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)]) + ggtitle(paste("Cleaned, RH, Non-Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_asleep_cl[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)])
p6 <- blandr.draw(df$time_asleep_cl[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_asleep_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)]) + ggtitle(paste("Cleaned, RH, Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

gridExtra::grid.arrange(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

pall <- gridExtra::arrangeGrob(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

ggsave("~/Box/CogNeuroLab/Wearables/results/time_asleep_bland_altman.png", pall, scale = 1.5, dpi = 300)
```

```{r}
library(blandr)

df.stats <- blandr.statistics(df$time_in_bed_act , df$time_in_bed_fit)
p1 <- blandr.draw(df$time_in_bed_act , df$time_in_bed_fit ) + ggtitle(paste("Raw Actiwatch, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_in_bed_cl , df$time_in_bed_fit)
p2 <- blandr.draw(df$time_in_bed_cl , df$time_in_bed_fit) + ggtitle(paste("Cleaned Actiwatch, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_in_bed_act[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)])
p3 <- blandr.draw(df$time_in_bed_act[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)]) + ggtitle(paste("Raw, RH, Non-Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_in_bed_act[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)])
p4 <- blandr.draw(df$time_in_bed_act[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)]) + ggtitle(paste("Raw, RH, Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_in_bed_cl[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)])
p5 <- blandr.draw(df$time_in_bed_cl[(df$actiwatch_arm == 1) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 1) & (df$handedness == 2)]) + ggtitle(paste("Cleaned, RH, Non-Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.stats <- blandr.statistics(df$time_in_bed_cl[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)])
p6 <- blandr.draw(df$time_in_bed_cl[(df$actiwatch_arm == 2) & (df$handedness == 2)] , df$time_in_bed_fit[(df$actiwatch_arm == 2) & (df$handedness == 2)]) + ggtitle(paste("Cleaned, RH, Dominant, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

gridExtra::grid.arrange(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

pall <- gridExtra::arrangeGrob(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

ggsave("~/Box/CogNeuroLab/Wearables/results/time_in_bed_bland_altman.png", pall, scale = 1.5, dpi = 300)
```

