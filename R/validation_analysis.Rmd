---
title: "Sleep Summary Stats Comparison"
author: "Megan McMahon"
date: "3/12/2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(tableone)
library(xtable)

data_dir <- '~/Box/CogNeuroLab/Wearables/data/'
results_dir <- '~/Box/CogNeuroLab/Wearables/results/'
df <- read.csv(paste0(data_dir, "sleep_stats.csv"))
redcap <- read.csv(paste0(data_dir, "WearableAssessment_DATA_2021-07-12_1250.csv"))

demog <- redcap %>%
  group_by(record_id) %>% fill('experimenter_1_complete', .direction = 'updown') %>% fill('experimenter_2_complete', .direction = 'updown') %>% ungroup() %>%
  filter(experimenter_2_complete == 2) %>%
  #filter(difftime(as.Date("2021-01-01"), lubridate::ymd(redcap$contact_date)) > 0) %>%
  filter(redcap_event_name == "online_eligibility_arm_1") %>%
  mutate(age = as.numeric(difftime(as.Date(Sys.Date()), as.Date(dob), units = "weeks")/52.25)
  ) %>%
  select(record_id, age, age_group, gender, gender_other, contains("ethnicity_"), handedness, education_level, sleep_med, sleep_hours, sleep_disorder, global_psqi) %>%
  filter(age_group %in% c(1, 2)) %>%
  mutate(age_group = factor(age_group, levels = c(1,2), labels = c("Young Adults", "Older Adults")),
         handedness = factor(handedness, levels = c(1,2,3), labels = c("Left", "Right", "Both")),
         education_level = factor(education_level, levels = c(1,2,3,4,5,6,7,8), labels = c("Less than high school", "High school/GED", "Some college", "Associate's degree", "Bachelor's degree", "Master's degree", "Doctoral degree", "Other")),
         gender = factor(gender, levels = c(1,2), labels = c("Male", "Female"))) %>% #1 male, 2 female
  mutate_each(funs(factor), starts_with("ethnicity_"), sleep_med, sleep_disorder) %>%
  rename('African American' = 'ethnicity___1',
         'Asian' = 'ethnicity___2',
         'Caucasian' = 'ethnicity___3',
         'Hispanic' = 'ethnicity___4',
         'Native American' = 'ethnicity___5',
         'Other' = 'ethnicity___6') %>%
  janitor::clean_names(case = "title")

# 1	Less than high school
# 2	High school/GED
# 3	Some college
# 4	Associate's degree
# 5	Bachelor's degree
# 6	Master's degree
# 7	Doctoral degree
# 8	Other

demog

demog_table <- print(CreateTableOne(data = select(demog, -`Record Id`), strata = 'Age Group', includeNA = FALSE, test = FALSE), minMax = TRUE, noSpaces = TRUE)

demog_table

print(xtable(demog_table, type = "latex"), file = paste0(data_dir, "demog_table.tex"))

```

# Clean data frame
```{r}

df <- df %>%
  mutate(dominant = factor(ifelse(handedness == actiwatch_arm, 1, 0), levels = c(1,0), labels = c("Dominant", "Non-Dominant"))) %>%
  mutate(age_group = factor(age_group, levels = c("Young Adults", "Older Adults")), 
         handedness = factor(handedness, levels = c("Left", "Right", "Both")),
         actiwatch_arm = factor(actiwatch_arm, levels = c("Left", "Right")),
         sleep_duration_act_manual = as.numeric(difftime(wake_time_act, bed_time_act, units = "m")), #manually calculating because beiwe sleep time values not pulling correctly?
         sleep_duration_fit_manual = as.numeric(difftime(wake_time_fit, bed_time_fit, units = "m")))

df %>%
  select(subject, age_group, handedness, actiwatch_arm, dominant, sleep_duration_act_manual, sleep_duration_fit_manual) %>%
  head()

```

## Only  keep bed and wake times that are closest (not nap times)
Fitbit is reporting multiple bed times for every given Actiwatch bed time for many subjects.

```{r}
d0 <- df
df <- d0 %>%
  drop_na(age_group, subject) %>%
  mutate(subject = as.factor(subject),
         tdif = abs(difftime(bed_time_act, bed_time_fit, units = "m")),
         joinid = paste(subject, join_date)) %>%
  group_by(joinid) %>%
  arrange(tdif) %>%
  slice(1)

```

Exclude participants' second runs if they did the study twice

```{r}
df <- df %>%
  group_by(subject) %>%
  arrange(join_date) %>%
  mutate(lag_time = difftime(join_date, lag(join_date), units = "days")) %>%
  mutate(arm = ifelse(lag_time > 7, "2", NA)) %>%
  arrange(subject) %>%
  fill(arm, .direction = "down") %>%
  mutate(arm = replace_na(arm, 1)) %>%
  ungroup() %>%
  filter(arm == 1)

# how many subjects have fewer than 5 days of sleep statistics reported?
df %>%
  select(subject, join_date, bed_time_act, bed_time_fit) %>%
  group_by(subject) %>%
  summarise(n_act = sum((!is.na(bed_time_fit) & !is.na(bed_time_act)))) %>%
  filter(n_act < 5) 

df %>%
  select(subject, bed_time_act, bed_time_fit) %>%
  filter(subject == "10014")

```
Maybe didn't sync data at the end of the study?

## How many left handers?
```{r}
df %>%
  select(subject, age_group, dominant) %>%
  group_by(age_group, dominant) %>%
  distinct(subject, keep_all = T) %>%
  drop_na(age_group) %>%
  summarise(n = n())

df %>%
  filter(handedness == "Right") %>%
  select(subject, age_group, dominant) %>%
  group_by(age_group, dominant) %>%
  distinct(subject, keep_all = T) %>%
  drop_na(age_group) %>%
  summarise(n = n())

df %>%
  filter(handedness == "Left") %>%
  select(subject, age_group, dominant) %>%
  group_by(age_group, dominant) %>%
  distinct(subject, keep_all = T) %>%
  drop_na(age_group) %>%
  summarise(n = n())

```


```{r}
#exclude = c('10023', '10076', '20182', '20184', '20176', '10151', '10139', 
#            '23', '76', '182', '184', '176', '151', '139') 

# I think these subjects are being excluded because of missingness/not wearing the watch, but I need to check the jupyter notebook to make sure. For now, not going to exclude because there are so many.

# df %>%
#   filter(!subject %in% exclude) %>%
#   select(subject) %>%
#   distinct()

```

### Repeated measures correlations

[Documentation](https://cran.r-project.org/web/packages/rmcorr/rmcorr.pdf)

[Repeated Measures Correlation, Bakdash1 and Marusich, 2017](https://www.frontiersin.org/articles/10.3389/fpsyg.2017.00456/full)

#### Time in Bed

```{r warning = F}
histplot <- df %>%
  ggplot() +
  geom_histogram(aes(x = tdif, fill = age_group)) +
  facet_wrap(~ age_group) +
  scale_fill_brewer(palette = "Set1", name = "Age Group") +
  xlab("") + ylab("Count")

ggsave(paste0(results_dir, "bedtimedifs.png"), histplot, height = 3.5, units = "in", dpi = 300)

histplot

```

#### Sleep time

```{r}

library(rmcorr)
library(RColorBrewer)

colourCount = length(unique(df$subject))
getPalette = colorRampPalette(brewer.pal(9, "Spectral"))

dfcor <- df %>%
  drop_na(sleep_duration_act_manual, sleep_duration_fit_manual)

dfcor %>%
  select(sleep_duration_act, sleep_duration_act_manual, sleep_duration_fit, sleep_duration_fit_manual)

my.rmc <- rmcorr(participant = subject, measure1 = sleep_duration_act_manual, measure2 = sleep_duration_fit_manual, dataset = dfcor)
my.rmc

rmcorr(participant = subject, measure1 = sleep_duration_act_manual, measure2 = sleep_duration_fit_manual, dataset = filter(dfcor, age_group == "Young Adults"))
rmcorr(participant = subject, measure1 = sleep_duration_act_manual, measure2 = sleep_duration_fit_manual, dataset = filter(dfcor, age_group == "Older Adults")) # lower for OA

dfcor %>% 
  ggplot(aes(x = sleep_duration_act_manual, y = sleep_duration_fit_manual, group = subject,
             color = subject)) +
  geom_point(aes(colour = subject)) +
  geom_line(aes(y = my.rmc$model$fitted.values), linetype = 1) + 
  xlab('Actiwatch 2.0') + ylab('Fitbit') + 
  ggtitle('Sleep Duration') + 
  scale_color_manual(values = getPalette(colourCount)) + 
  labs(color = 'Subject')

```


```{r}
my.rmc <- rmcorr(participant = subject, measure1 = time_in_bed_act, measure2 = time_in_bed_fit, dataset = dfcor)
my.rmc 

rmcorr(participant = subject, measure1 = time_in_bed_act, measure2 = time_in_bed_fit, dataset = filter(dfcor, age_group == "Young Adults"))
rmcorr(participant = subject, measure1 = time_in_bed_act, measure2 = time_in_bed_fit, dataset = filter(dfcor, age_group == "Older Adults")) # lower for OA

```

```{r}
dfcor %>%
  ggplot(aes(x = time_in_bed_act, y = time_in_bed_fit, group = subject,
             color = subject)) +
  geom_point(aes(colour = subject)) +
  geom_line(aes(y = my.rmc$model$fitted.values), linetype = 1) + 
  xlab('Actiwatch 2.0') + ylab('Fitbit') + 
  ggtitle('Time In Bed') + 
  scale_color_manual(values = getPalette(colourCount)) + 
  labs(color = 'Subject')

```

### Next steps: 
Need correlation value for each subject, then see how that's related to measures of subjective sleep quality, handedness, arm assignment, percent watch off, beiwe, fitbit device

```{r}
corrdf <- dfcor %>%
  group_by(subject) %>%
  summarize(sleep_duration_r = cor(sleep_duration_act_manual, sleep_duration_fit_manual, method = 'spearman'), 
            time_in_bed_r = cor(time_in_bed_act, time_in_bed_fit, method = 'spearman'))

dfcor <- merge(df, corrdf, by = 'subject')

head(corrdf)

```

## How many subjects have r values less than 0.5 for sleep duration and time in bed?

```{r}
unique(dfcor$subject[dfcor$time_in_bed_r < 0.5])
length(unique(dfcor$subject[dfcor$time_in_bed_r < 0.5]))

unique(dfcor$subject[dfcor$sleep_duration_r < 0.5])
length(unique(dfcor$subject[dfcor$sleep_duration_r < 0.5]))

```


```{r}
require(gridExtra)

plot1 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = fitbit_device, y = sleep_duration_r, fill = fitbit_device, group = fitbit_device)) +
  ylab('Sleep Duration Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + theme(axis.text.x = element_text(angle = 90))

plot2 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = fitbit_device, y = time_in_bed_r, fill = fitbit_device, group = fitbit_device)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + theme(axis.text.x = element_text(angle = 90))

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave(paste0(results_dir, "fitbit_device.png"), pnew, height = 5, width = 10, units = "in")

plot(pnew)

```

```{r}

plot1 <- dfcor %>%
  drop_na(platform_fit) %>%
  ggplot(aes(x = platform_fit, y = sleep_duration_r, fill = platform_fit, group = platform_fit)) + 
  geom_boxplot() +
  ylab('Sleep Duration Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + theme(axis.text.x = element_text(angle = 90))

plot2 <- dfcor %>%
  drop_na(platform_fit) %>%
  ggplot(aes(x = platform_fit, y = time_in_bed_r, fill = platform_fit, group = platform_fit)) + 
  geom_boxplot() +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + theme(axis.text.x = element_text(angle = 90))

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave(paste0(results_dir, "fitbit_platform.png"), pnew, height = 5, width = 10, units = "in")

plot(pnew)

```


```{r}
plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = handedness, y = sleep_duration_r, fill = handedness, group = handedness)) +
  ylab('Sleep Time Correlation (r)') + xlab('Handedness') +
  scale_fill_brewer(palette = 'Set1') 

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = handedness, y = time_in_bed_r, fill = handedness, group = handedness)) +
  ylab('Time In Bed Correlation (r)') + xlab('Handedness') +
  scale_fill_brewer(palette = 'Set1')

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave(paste0(results_dir, "handedness.png"), pnew, height = 5, width = 10, units = "in")

plot(pnew)
```

```{r}

plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = actiwatch_arm, y = sleep_duration_r, fill = actiwatch_arm, group = actiwatch_arm)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = actiwatch_arm, y = time_in_bed_r, fill = actiwatch_arm, group = actiwatch_arm)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave(paste0(results_dir, "actiwatchassignment.png"), pnew, height = 5, width = 10, units = "in")

plot(pnew)

```

```{r}

plot1 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = dominant, y = sleep_duration_r, fill = dominant, group = dominant)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

plot2 <- dfcor %>%
  filter(handedness != "Both") %>%
  ggplot() + 
  geom_boxplot(aes(x = dominant, y = time_in_bed_r, fill = dominant, group = dominant)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Actiwatch Arm")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave(paste0(results_dir, "actiwatchassignment_dominant.png"), pnew, height = 5, width = 10, units = "in")

plot(pnew)
```

```{r}
plot1 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = sleep_duration_r, fill = age_group, group = age_group)) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

plot2 <- dfcor %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = time_in_bed_r, fill = age_group, group = age_group)) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/agegroup.png", pnew, height = 5, width = 10, units = "in")

plot(pnew)

```
```{r}
plot1 <- dfcor %>%
  drop_na(platform_fit) %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = sleep_duration_r, group = platform_fit, fill = platform_fit)) +
  facet_wrap(. ~ age_group) +
  ylab('Sleep Time Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

plot2 <- dfcor %>%
  drop_na(platform_fit) %>%
  ggplot() + 
  geom_boxplot(aes(x = age_group, y = time_in_bed_r, group = platform_fit, fill = platform_fit)) +
  facet_wrap(. ~ age_group) +
  ylab('Time In Bed Correlation (r)') +
  scale_fill_brewer(palette = 'Set1') + xlab("Age Group")

pnew <- arrangeGrob(plot1, plot2, ncol=2)
ggsave("~/Desktop/agegroup_beiwe.png", pnew, height = 5, width = 10, units = "in")

plot(pnew)
```


## Bland Altman plots

About the package: [blandr](https://cran.r-project.org/web/packages/blandr/vignettes/introduction.html)
Interpretation: [Statology](https://www.statology.org/bland-altman-plot/)

e.g.

The average of the values in the Difference column turns out to be 0.5. (middle line)
The standard deviation of values in the Difference column turns out to be 1.235.
The upper and lower limits of the confidence interval for the average difference can be calculated as:

Upper Limit: x + 1.96*s = 0.5 + 1.96*1.235 = 2.92
Lower Limit: x – 1.96*s = 0.5 – 1.96*1.235 = -1.92

On average, instrument A weighs frogs to be 0.5 grams heavier than instrument B.
95% of the differences in weight between the two instruments are expected to fall in the range of -1.92 grams and 2.92 grams.

First look at which device may be under or over estimating
- Fitbit underestimating sleep time and time in bed

```{r}

# fitbit underestimating sleep time
df %>%
  ggplot(aes(x = sleep_duration_act, y = sleep_duration_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

#fitbit underestimating time in bed
df %>%
  ggplot(aes(x = time_in_bed_act, y = time_in_bed_fit)) +
  geom_point() + 
  stat_smooth(method = "lm")

```

```{r}
library(blandr)

df.stats <- blandr.statistics(df$sleep_duration_act , df$sleep_duration_fit)
p1 <- blandr.draw(df$sleep_duration_act , df$sleep_duration_fit ) + ggtitle(paste("bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.statsya <- blandr.statistics(df$sleep_duration_act[df$age_group == "Young Adults"] , df$sleep_duration_fit[df$age_group == "Young Adults"])
pya <- blandr.draw(df$sleep_duration_act[df$age_group == "Young Adults"], df$sleep_duration_fit[df$age_group == "Young Adults"] ) + ggtitle(paste("Young Adults \n bias=", signif(df.statsya$bias, 4), "lower=", signif(df.statsya$lowerLOA, 4), "upper=", signif(df.statsya$upperLOA, 4)))
pya

df.statsoa <- blandr.statistics(df$sleep_duration_act[df$age_group == "Older Adults"] , df$sleep_duration_fit[df$age_group == "Older Adults"])
poa <- blandr.draw(df$sleep_duration_act[df$age_group == "Older Adults"], df$sleep_duration_fit[df$age_group == "Older Adults"] ) + ggtitle(paste("Older Adults \n bias=", signif(df.statsoa$bias, 4), "lower=", signif(df.statsoa$lowerLOA, 4), "upper=", signif(df.statsoa$upperLOA, 4)))
poa

df.statsbeiwe <- blandr.statistics(df$sleep_duration_act[df$platform_fit == "Beiwe"] , df$sleep_duration_fit[df$platform_fit == "Beiwe"])
pbeiwe <- blandr.draw(df$sleep_duration_act[df$platform_fit == "Beiwe"], df$sleep_duration_fit[df$platform_fit == "Beiwe"] ) + ggtitle(paste("Beiwe \n bias=", signif(df.statsbeiwe$bias, 4), "lower=", signif(df.statsbeiwe$lowerLOA, 4), "upper=", signif(df.statsbeiwe$upperLOA, 4)))
pbeiwe

df.statsfitabase <- blandr.statistics(df$sleep_duration_act[df$platform_fit == "Fitabase"] , df$sleep_duration_fit[df$platform_fit == "Fitabase"])
pfitabase <- blandr.draw(df$sleep_duration_act[df$platform_fit == "Fitabase"], df$sleep_duration_fit[df$platform_fit == "Fitabase"] ) + ggtitle(paste("Fitabase \n bias=", signif(df.statsfitabase$bias, 4), "lower=", signif(df.statsfitabase$lowerLOA, 4), "upper=", signif(df.statsfitabase$upperLOA, 4)))
pfitabase

#pall <- gridExtra::arrangeGrob(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

ggsave(paste0(results_dir, "blandsleepduration.png"), p1, scale = 1.5, dpi = 300)
ggsave(paste0(results_dir, "blandsleepdurationya.png"), pya, scale = 1.5, dpi = 300)
ggsave(paste0(results_dir, "blandsleepdurationoa.png"), poa, scale = 1.5, dpi = 300)

p1
```

```{r}
library(blandr)

df.stats <- blandr.statistics(df$time_in_bed_act , df$time_in_bed_fit)
p1 <- blandr.draw(df$time_in_bed_act , df$time_in_bed_fit ) + ggtitle(paste("bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))

df.statsya <- blandr.statistics(df$time_in_bed_act[df$age_group == "Young Adults"] , df$time_in_bed_fit[df$age_group == "Young Adults"])
pya <- blandr.draw(df$time_in_bed_act[df$age_group == "Young Adults"], df$time_in_bed_fit[df$age_group == "Young Adults"] ) + ggtitle(paste("Young Adults \n bias=", signif(df.statsya$bias, 4), "lower=", signif(df.statsya$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))
pya

df.statsoa <- blandr.statistics(df$time_in_bed_act[df$age_group == "Older Adults"] , df$time_in_bed_fit[df$age_group == "Older Adults"])
poa <- blandr.draw(df$time_in_bed_act[df$age_group == "Older Adults"], df$time_in_bed_fit[df$age_group == "Older Adults"] ) + ggtitle(paste("Older Adults \n bias=", signif(df.statsoa$bias, 4), "lower=", signif(df.statsoa$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))
poa

# df.stats <- blandr.statistics(df$time_in_bed_cl , df$time_in_bed_fit)
# p2 <- blandr.draw(df$time_in_bed_cl , df$time_in_bed_fit) + ggtitle(paste("Cleaned Actiwatch, \n bias=", signif(df.stats$bias, 4), "lower=", signif(df.stats$lowerLOA, 4), "upper=", signif(df.stats$upperLOA, 4)))


# gridExtra::grid.arrange(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)

# pall <- gridExtra::arrangeGrob(p1, p2, p3, p4, p5, p6, nrow=3, ncol=2)
p1
ggsave(paste0(results_dir, "blandtib.png"), p1, scale = 1.5, dpi = 300)
ggsave(paste0(results_dir, "blandtibya.png"), pya, scale = 1.5, dpi = 300)
ggsave(paste0(results_dir, "blandtiboa.png"), poa, scale = 1.5, dpi = 300)

```

## Correspondance with Sleep Diary Data

```{r, include = FALSE, echo = FALSE}

diary <- read_csv(paste0(data_dir, 'sleep_diaries/sleep_diaries_all.csv')) 

diary <- diary %>%
  mutate_at(vars(contains("time")), ~as.POSIXct(., tz = "UTC", format = '%Y-%m-%d %H:%M')) %>%
  mutate(date = lubridate::as_date(timestamp, tz = "UTC")) %>% # this is the date they filled it out but if they forgot to complete the diary the morning after and instead completed it a day later, this will be wrong
  rename(subject = record_id) %>%
  mutate(subject = as.character(subject)) %>%
  group_by(subject) %>%
  arrange(timestamp) %>%
  mutate(lag_time = difftime(timestamp, lag(timestamp), units = "days")) %>%
  mutate(arm = ifelse(lag_time > 7, "2", NA)) %>%
  arrange(subject) %>%
  fill(arm, .direction = "down") %>%
  mutate(arm = replace_na(arm, 1)) %>%
  ungroup() %>%
  filter(arm == 1)

diary_table <- diary %>%
  group_by(subject) %>%
  mutate(age_group = ifelse(subject < 20000, "Young Adults", "Older Adults"),
         completion_days = length(unique(event_name)),
         completion_percent = ifelse(max(event_name, na.rm = T) > 14,
                                     (length(unique(event_name))/14)*100,
                                      (length(unique(event_name))/(max(event_name, na.rm = T)))*100),
         participation_days = max(event_name, na.rm = T)) %>%
  select(age_group, completion_days, participation_days, completion_percent) %>%
  distinct() %>%
  group_by(age_group) %>%
  summarise(across(completion_days:completion_percent, list(mean = mean, sd = sd)))

print(xtable(diary_table, type = "latex"), file = paste0(data_dir, "diary_table.tex"))

diary_table

```


```{r}
participant = "10038"

df %>%
  mutate_at(vars(contains("bed_time")), ~as.POSIXct(., tz = "UTC", format = '%Y-%m-%d %H:%M')) %>%
  mutate_at(vars(contains("wake_time")), ~as.POSIXct(., tz = "UTC", format = '%Y-%m-%d %H:%M')) %>%
  group_by(subject) %>%
  filter(subject == participant) %>%
  select(bed_time_act, bed_time_fit)

```


```{r}
library(scales)

act_files <- list.files("~/Box/CogNeuroLab/Wearables/data/actiwatch/act_files/preproc/", full.names = T)

dfn <- df %>%
  mutate_at(vars(contains("bed_time")), ~as.POSIXct(., tz = "UTC", format = '%Y-%m-%d %H:%M')) %>%
  mutate_at(vars(contains("wake_time")), ~as.POSIXct(., tz = "UTC", format = '%Y-%m-%d %H:%M')) %>%
  mutate(date = lubridate::as_date(wake_time_act, tz = "UTC")) %>%
  rename(event_name = interval_number_act) %>%
  group_by(subject) %>%
  arrange(date) %>%
  distinct(bed_time_act, .keep_all = TRUE) %>%
  merge(diary, by = c('subject', 'event_name'), all = T) %>%
  mutate(sleep_duration_diary = difftime(wake_time, sleep_time, units = "m"),
         time_in_bed_diary = difftime(wake_time, sleep_time, units = "m") + sleep_minutes) %>% #adding onset latency to sleep time
  arrange(subject, event_name)

check <- dfn %>%
  select(subject, event_name, bed_time, bed_time_act, bed_time_fit, wake_time, wake_time_act, wake_time_fit)

check
```

##
```{r}
df.statssl <- blandr.statistics(as.numeric(dfn$sleep_duration_diary), as.numeric(dfn$sleep_duration_act))
psl<- blandr.draw(as.numeric(dfn$sleep_duration_diary), as.numeric(dfn$sleep_duration_act)) + ggtitle(paste("bias=", signif(df.statssl$bias, 4), "lower=", signif(df.statssl$lowerLOA, 4), "upper=", signif(df.statssl$upperLOA, 4)))
psl

```

```{r}
df.statsslf <- blandr.statistics(as.numeric(dfn$sleep_duration_diary), as.numeric(dfn$sleep_duration_fit))
pslf<- blandr.draw(as.numeric(dfn$sleep_duration_diary), as.numeric(dfn$sleep_duration_fit)) + ggtitle(paste("bias=", signif(df.statsslf$bias, 4), "lower=", signif(df.statsslf$lowerLOA, 4), "upper=", signif(df.statsslf$upperLOA, 4)))
pslf
```


## Bedtime agreement

```{r}
df.statsbedtime <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$bed_time_act, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_fit, "%H:%M:%S")))/60/60)
pbedtime <- blandr.draw(as.numeric(lubridate::hms(format(dfn$bed_time_act, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_fit, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statsbedtime$bias, 4), "lower=", signif(df.statsbedtime$lowerLOA, 4), "upper=", signif(df.statsbedtime$upperLOA, 4)))
pbedtime
```



```{r}
df.statsdiary <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$bed_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_act, "%H:%M:%S")))/60/60)
pdiary <- blandr.draw(as.numeric(lubridate::hms(format(dfn$bed_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_act, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statsdiary$bias, 4), "lower=", signif(df.statsdiary$lowerLOA, 4), "upper=", signif(df.statsdiary$upperLOA, 4)))
pdiary
```

```{r}
df.statsdiaryfit <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$bed_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_fit, "%H:%M:%S")))/60/60)
pdiaryfit <- blandr.draw(as.numeric(lubridate::hms(format(dfn$bed_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$bed_time_fit, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statsdiaryfit$bias, 4), "lower=", signif(df.statsdiaryfit$lowerLOA, 4), "upper=", signif(df.statsdiaryfit$upperLOA, 4)))
pdiaryfit
```

##

## Wake time agreement

```{r}
df.statswaketime <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$wake_time_act, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_fit, "%H:%M:%S")))/60/60)
pwaketime <- blandr.draw(as.numeric(lubridate::hms(format(dfn$wake_time_act, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_fit, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statswaketime$bias, 4), "lower=", signif(df.statswaketime$lowerLOA, 4), "upper=", signif(df.statswaketime$upperLOA, 4)))
pwaketime
```


```{r}
df.statsdiary <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$wake_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_act, "%H:%M:%S")))/60/60)
pdiary <- blandr.draw(as.numeric(lubridate::hms(format(dfn$wake_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_act, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statsdiary$bias, 4), "lower=", signif(df.statsdiary$lowerLOA, 4), "upper=", signif(df.statsdiary$upperLOA, 4)))
pdiary
```

```{r}


```

```{r}
df.statsdiaryfit <- blandr.statistics(as.numeric(lubridate::hms(format(dfn$wake_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_fit, "%H:%M:%S")))/60/60)
pdiaryfit <- blandr.draw(as.numeric(lubridate::hms(format(dfn$wake_time, "%H:%M:%S")))/60/60, as.numeric(lubridate::hms(format(dfn$wake_time_fit, "%H:%M:%S")))/60/60 ) + ggtitle(paste("bias=", signif(df.statsdiaryfit$bias, 4), "lower=", signif(df.statsdiaryfit$lowerLOA, 4), "upper=", signif(df.statsdiaryfit$upperLOA, 4)))
pdiaryfit
```

```{r}

for (participant in unique(df$subject)){
  
  if (length(act_files[grep(participant, act_files)]) > 0){
    rawact <-
      read_csv(act_files[grep(participant, act_files)], col_names = c("date", "activity"))
    
    rawact <- rawact %>%
      group_by(format(ymd_hms(date), "%Y-%m-%d"), lubridate::hour(lubridate::ymd_hms(date))) %>%
      summarize(activity = sum(activity))
    
    colnames(rawact) <- c("date", "time", "activity")
    
    rawact <- rawact %>%
      mutate(datetime = as.POSIXct(paste(date, str_pad(paste0(time, ":00:00"), width = 8, pad = "0")), tz = "UTC", format = "%Y-%m-%d %H:%M:%S"))
    
    try(dfn %>%
          filter(subject == participant) %>%
          ggplot() +
          geom_line(data = rawact, aes(x = datetime, y = activity)) +
          geom_vline(aes(xintercept = bed_time_act, color = 'Actiwatch', linetype = 'dotted')) +
          geom_vline(aes(xintercept = wake_time_act, color = 'Actiwatch', linetype = 'dotted')) +
          geom_vline(aes(xintercept = bed_time_fit, color = 'Fitbit', linetype = 'longdash')) +
          geom_vline(aes(xintercept = wake_time_fit, color = 'Fitbit', linetype = 'longdash')) +
          geom_vline(aes(xintercept = bed_time, color = "Self-Report", linetype = 'dashed')) +
          geom_vline(aes(xintercept = wake_time, color = "Self-Report", linetype = 'dashed')) +
          theme_minimal() + 
          scale_x_datetime(breaks = date_breaks("3 hours"), minor_breaks=date_breaks("1 hour"), labels=date_format("%H")) +
          facet_wrap( ~ date, scales = "free_x") + 
          guides(alpha = F, size = F, linetype = F) +
          scale_color_discrete(name = "Method") + xlab("Time") + ylab("Activity") +
          ggsave(paste0(results_dir, "diary_comparison/", participant, ".pdf"), dpi = 400),
        silent = T)
    
  }
  
}

write.csv(select(dfn, subject, age_group, actiwatch_arm, handedness, fitbit_device, bed_time, bed_time_act, bed_time_fit, wake_time, wake_time_act, wake_time_fit),"~/Box/CogNeuroLab/Wearables/data/sleep_diaries/bed-wake-time-comparison.csv", row.names = F)

```

```{r}

dfn %>%
  mutate(sleep_duration_diary = as.numeric(difftime(wake_time, bed_time, units = "m")),
         sleep_duration_act_manual = as.numeric(difftime(wake_time_act, bed_time_act, units = "m")),
         sleep_duration_fit_manual = as.numeric(difftime(wake_time_fit, bed_time_fit, units = "m"))) %>%
  select(sleep_duration_act_manual, sleep_duration_act, sleep_duration_fit, sleep_duration_fit_manual)

```

```{r}
dfn <- dfn %>%
  mutate(sleep_duration_diary = as.numeric(difftime(wake_time, bed_time, units = "m")),
         sleep_duration_act_manual = as.numeric(difftime(wake_time_act, bed_time_act, units = "m")),
         sleep_duration_fit_manual = as.numeric(difftime(wake_time_fit, bed_time_fit, units = "m")))

rmcorr(participant = subject, measure1 = sleep_duration_diary, measure2 = sleep_duration_act, dataset = dfn)
rmcorr(participant = subject, measure1 = sleep_duration_diary, measure2 = sleep_duration_fit, dataset = dfn)

```

## Activity count correlations

```{r}
for (subject_file in list.files(path = paste0(data_dir, "actiwatch/act_files/preproc/"), full.names = T, pattern = "*.csv")){
  act <- read.csv(subject_file, )
  print(paste0(substring(basename(subject_file), 0, 5), " duration is ", difftime(act[length(act[,1]),1], act[1,1]), " days"))
  
}

```


